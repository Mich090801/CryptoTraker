<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Criptomoneda</title>
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #1f1f1f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
    }

    header h1 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
    }

    header nav a {
      color: #ccc;
      margin: 0 1rem;
      text-decoration: none;
    }

    header nav a:hover {
      color: #fff;
    }

    .container {
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      text-align: center;
    }

    .crypto-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .crypto-info img {
      width: 50px;
      height: 50px;
    }

    .select-hours {
      margin-bottom: 1.5rem;
    }

    .select-hours select {
      padding: 0.5rem;
      font-size: 1rem;
      background-color: #1f1f1f;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
    }

    .chart {
      background-color: #1e1e1e;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .chart img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #444;
    }

    th {
      background-color: #1f1f1f;
    }

    tr:nth-child(even) {
      background-color: #1a1a1a;
    }

    tr:nth-child(odd) {
      background-color: #222;
    }
  </style>
</head>
<body>

  <header>
    <h1>ü™ô CryptoTracker</h1>
    <nav>
      <a href="index.html">Inicio</a>
      <a href="comparar.html">Comparaci√≥n</a>
      <a href="regresion.html">Regresi√≥n</a>
    </nav>
  </header>

  <div class="container">
    <div class="crypto-info">
      <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" alt="Bitcoin">
      <h2 id="coin-name">Bitcoin (BTC)</h2>
    </div>

    <div class="select-hours">
      <label for="range">Selecciona un rango de horas:</label>
      <select id="range">
        <option value="1">√öltima 1 hora</option>
        <option value="3">√öltimas 3 horas</option>
        <option value="6">√öltimas 6 horas</option>
        <option value="12">√öltimas 12 horas</option>
        <option value="24" selected>√öltimas 24 horas</option>
      </select>
    </div>

    <div class="chart">
      <img id="chart-img" src="http://localhost:8080/chart?coin=bitcoin&hours=24" alt="Gr√°fico hist√≥rico de BTC">
    </div>

    <div id="chart-container"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Obtener par√°metros de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const coinId = urlParams.get('coin') || 'bitcoin';
      const iconSrc = urlParams.get('icon');
      const coinName = urlParams.get('name');
      const coinSymbol = urlParams.get('symbol');
      const coinColor = urlParams.get('color') || '#3f51b5';
      
      console.log(`Mostrando historial para: ${coinId}`);
      
      // Aplicar color de la criptomoneda a elementos de la p√°gina
      applyThemeColor(coinColor);
      
      // Si tenemos todos los par√°metros necesarios, usarlos directamente
      if (iconSrc && coinName && coinSymbol) {
        // Actualizar la informaci√≥n de la criptomoneda
        document.querySelector('.crypto-info').innerHTML = `
          <img src="${decodeURIComponent(iconSrc)}" alt="${decodeURIComponent(coinName)} logo">
          <h2 id="coin-name">${decodeURIComponent(coinName)} (${decodeURIComponent(coinSymbol)})</h2>
        `;
        
        // Actualizar t√≠tulo de la p√°gina
        document.title = `${decodeURIComponent(coinName)} (${decodeURIComponent(coinSymbol)}) - Historial | CryptoTracker`;
      } else {
        // Si faltan par√°metros, usar el mapeo local como fallback
        updateCryptoInfo(coinId);
      }
      
      // Actualizar la imagen del gr√°fico con la criptomoneda seleccionada
      const rangeSelect = document.getElementById('range');
      const hours = rangeSelect.value;
      document.getElementById('chart-img').src = `http://localhost:8080/chart?coin=${coinId}&hours=${hours}`;
      
      // Configurar el event listener para el cambio de rango
      rangeSelect.addEventListener('change', () => {
        const updatedHours = rangeSelect.value;
        document.getElementById('chart-img').src = `http://localhost:8080/chart?coin=${coinId}&hours=${updatedHours}`;
        
        // Tambi√©n actualizar los datos hist√≥ricos cuando cambia el rango
        loadHistoricalData(coinId, updatedHours);
      });
      
      // Cargar los datos hist√≥ricos inicialmente
      loadHistoricalData(coinId, hours);
    });

    // Funci√≥n para aplicar el color de la criptomoneda a los elementos de la p√°gina
    function applyThemeColor(color) {
      // Crear un elemento style para a√±adir reglas CSS personalizadas
      const style = document.createElement('style');
      style.textContent = `
        header {
          border-bottom: 3px solid ${color};
        }
        
        .chart {
          border-left: 4px solid ${color};
        }
        
        th {
          border-bottom: 2px solid ${color};
        }
        
        .select-hours select {
          border-color: ${color};
        }
        
        h3 {
          color: ${color};
        }
        
        .crypto-info img {
          box-shadow: 0 0 10px ${color}80;
        }
        
        #coin-name {
          text-shadow: 0 0 5px ${color}40;
        }
      `;
      
      document.head.appendChild(style);
    }

    // Funci√≥n separada para cargar datos hist√≥ricos
    function loadHistoricalData(coinId, hours) {
      fetch(`http://localhost:8080/history?coin=${coinId}&hours=${hours}`)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Error HTTP ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          console.log("Datos hist√≥ricos recibidos:", data);
          
          // Crear una tabla para mostrar los datos hist√≥ricos
          let tableHtml = `
            <h3>Historial de precios para ${coinId}</h3>
            <table>
              <thead>
                <tr>
                  <th>Fecha/Hora</th>
                  <th style="text-align:right;">Precio (USD)</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          if (data.length === 0) {
            tableHtml += `
              <tr>
                <td colspan="2" style="text-align:center;">No hay datos disponibles</td>
              </tr>
            `;
          } else {
            data.forEach((point) => {
              // Formatear la fecha
              const date = new Date(point.timestamp);
              const formattedDate = date.toLocaleString();
              
              // Formatear el precio con 2 decimales
              const formattedPrice = point.price.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              });
              
              tableHtml += `
                <tr>
                  <td>${formattedDate}</td>
                  <td style="text-align:right;">$${formattedPrice}</td>
                </tr>
              `;
            });
          }
          
          tableHtml += `
              </tbody>
            </table>
          `;
          
          document.getElementById('chart-container').innerHTML = tableHtml;
        })
        .catch(error => {
          console.error("Error al obtener datos hist√≥ricos:", error);
          document.getElementById('chart-container').innerHTML = 
            `<p style="color: red;">‚ùå No se pudieron cargar los datos hist√≥ricos para ${coinId}. Error: ${error.message}</p>`;
        });
    }

    // Funci√≥n de respaldo para actualizar info de criptomoneda si faltan par√°metros
    function updateCryptoInfo(coinId) {
      // Mapeo de IDs a nombres, s√≠mbolos e √≠conos locales
      const cryptoInfo = {
        'bitcoin': { 
          name: 'Bitcoin', 
          symbol: 'BTC', 
          icon: 'assets/bitcoin-circle-svgrepo-com.svg' 
        },
        'ethereum': { 
          name: 'Ethereum', 
          symbol: 'ETH', 
          icon: 'assets/ethereum-cryptocurrency-svgrepo-com.svg' 
        },
        'dogecoin': { 
          name: 'Dogecoin', 
          symbol: 'DOGE', 
          icon: 'assets/doge-svgrepo-com.svg' 
        },
        'cardano': { 
          name: 'Cardano', 
          symbol: 'ADA', 
          icon: 'assets/cardano-logo-svgrepo-com.svg' 
        },
        'solana': { 
          name: 'Solana', 
          symbol: 'SOL', 
          icon: 'assets/solana-svgrepo-com.svg' 
        },
        'ripple': { 
          name: 'XRP', 
          symbol: 'XRP', 
          icon: 'assets/xrp-svgrepo-com.svg' 
        },
        'chainlink': { 
          name: 'Chainlink', 
          symbol: 'LINK', 
          icon: 'assets/chainlink-svgrepo-com.svg' 
        },
        'tron': { 
          name: 'Tron', 
          symbol: 'TRX', 
          icon: 'assets/tron-crypto-svgrepo-com.svg' 
        },
        'hyperliquid': { 
          name: 'Hyperliquid', 
          symbol: 'HYP', 
          icon: 'assets/hyperliquid.svg' 
        }
      };

      // Obtener informaci√≥n para la moneda seleccionada o usar valores predeterminados
      const info = cryptoInfo[coinId] || { 
        name: coinId.charAt(0).toUpperCase() + coinId.slice(1), 
        symbol: coinId.toUpperCase(), 
        icon: 'https://via.placeholder.com/150?text=' + coinId.charAt(0).toUpperCase() 
      };
      
      // Actualizar la interfaz con la informaci√≥n de la criptomoneda
      document.querySelector('.crypto-info').innerHTML = `
        <img src="${info.icon}" alt="${info.name} logo">
        <h2 id="coin-name">${info.name} (${info.symbol})</h2>
      `;
      
      // Actualizar el t√≠tulo de la p√°gina
      document.title = `${info.name} (${info.symbol}) - Historial | CryptoTracker`;
    }
  </script>

</body>
</html>
